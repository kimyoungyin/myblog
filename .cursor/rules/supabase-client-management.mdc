# Supabase Client Management & Authentication (MANDATORY)

## üîê **Supabase Client Singleton Pattern (CRITICAL)**

Based on [src/utils/supabase/client.ts](mdc:src/utils/supabase/client.ts):

- **ALWAYS** use singleton pattern for Supabase client creation
- **NEVER** create multiple Supabase client instances
- **MUST** export a single client instance from the module
- **ALWAYS** use `createClient()` function to get the singleton instance

```typescript
// ‚úÖ CORRECT - Singleton pattern implementation
import { createClient as _createClient } from '@supabase/supabase-js';

// Module-level singleton instance
const supabase = _createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
);

// Export function that returns the same instance
export const createClient = () => supabase;

// ‚ùå WRONG - Multiple instances creation
export const createClient = () => {
    return _createClient(/* ... */); // Creates new instance every time!
};
```

## üö´ **FORBIDDEN Supabase Practices**

- **NEVER** use `useState` to create Supabase client in React components
- **NEVER** create new client instances in useEffect or event handlers
- **NEVER** import `createClient` from `@supabase/supabase-js` directly in components
- **NEVER** create multiple GoTrueClient instances in the same browser context

## ‚úÖ **REQUIRED Authentication Patterns**

Based on [src/hooks/useAuth.ts](mdc:src/hooks/useAuth.ts):

- **ALWAYS** use React Query for session and profile management
- **ALWAYS** use Zustand for local authentication state
- **NEVER** mix React Query and Zustand for the same data
- **ALWAYS** implement proper error handling for authentication failures

```typescript
// ‚úÖ CORRECT - Proper authentication hook usage
export function useAuth() {
    const { isLoading, setLoading, clearAuth } = useAuthStore();

    // React Query for server state
    const { data: session } = useQuery({
        queryKey: ['auth', 'session'],
        queryFn: async () => {
            const supabase = createClient(); // Use singleton
            const {
                data: { session },
            } = await supabase.auth.getSession();
            return session;
        },
        staleTime: 60 * 1000,
        refetchOnWindowFocus: false,
    });

    // Zustand for local state
    const signOut = useCallback(async () => {
        const supabase = createClient(); // Use singleton
        await supabase.auth.signOut();
        clearAuth();
    }, [clearAuth]);
}
```

## üèóÔ∏è **Provider Architecture (CURRENT STATE)**

Based on [src/components/providers/supabase-provider.tsx](mdc:src/components/providers/supabase-provider.tsx):

- **CURRENTLY**: SupabaseProvider is temporarily disabled
- **REASON**: Multiple GoTrueClient instances issue resolved with singleton pattern
- **FUTURE**: Will be reimplemented when authentication system is complete
- **NEVER** enable SupabaseProvider until authentication system is fully implemented

```typescript
// ‚úÖ CORRECT - Current temporary implementation
export function SupabaseProvider({ children }: { children: React.ReactNode }) {
    return (
        <SupabaseContext.Provider value={{ supabase: null }}>
            {children}
        </SupabaseContext.Provider>
    );
}

// ‚ùå WRONG - Don't enable until authentication system is complete
// <SupabaseProvider> // This is currently disabled
//     {children}
// </SupabaseProvider>
```

## üìÅ **File Organization for Supabase**

- **ALWAYS** keep Supabase client in [src/utils/supabase/client.ts](mdc:src/utils/supabase/client.ts)
- **ALWAYS** use `createClient()` function from this file
- **NEVER** create Supabase clients in other files
- **ALWAYS** import configuration from the same file

```typescript
// ‚úÖ CORRECT - Import from centralized location
import { createClient, supabaseConfig } from '@/utils/supabase/client';

// Use the singleton instance
const supabase = createClient();

// ‚ùå WRONG - Creating client elsewhere
import { createClient } from '@supabase/supabase-js';
const supabase = createClient(/* ... */);
```

## üîß **Configuration Management**

Based on [src/utils/supabase/client.ts](mdc:src/utils/supabase/client.ts):

- **ALWAYS** define Supabase configuration in the same file as the client
- **ALWAYS** use consistent naming for configuration objects
- **NEVER** hardcode configuration values in components
- **ALWAYS** export configuration for reuse

```typescript
// ‚úÖ CORRECT - Centralized configuration
export const supabaseConfig = {
    storageBucket: 'files',
    maxFileSize: 50 * 1024 * 1024, // 50MB
    allowedImageTypes: ['image/jpeg', 'image/png', 'image/webp', 'image/gif'],
    maxFiles: 20,
};

// ‚ùå WRONG - Scattered configuration
const config = { bucket: 'files' }; // In component file
```

## üö® **Error Prevention**

- **ALWAYS** check for environment variables before client creation
- **ALWAYS** handle authentication errors gracefully
- **NEVER** expose sensitive configuration in client-side code
- **ALWAYS** implement proper error boundaries for authentication failures

## üìö **Best Practices Summary**

1. **Singleton Pattern**: Use single Supabase client instance
2. **Centralized Configuration**: Keep all Supabase config in one place
3. **Proper Imports**: Always import from [src/utils/supabase/client.ts](mdc:src/utils/supabase/client.ts)
4. **Authentication Separation**: Use React Query for server state, Zustand for local state
5. **Provider Management**: Keep SupabaseProvider disabled until authentication system is complete
6. **Error Handling**: Implement proper error boundaries and user feedback

description: Supabase client management and authentication patterns to prevent Multiple GoTrueClient instances
globs: ["**/*.ts", "**/*.tsx"]
alwaysApply: true
